# 📗챕터 정리

## ❔ 실행 컨텍스트
실행 컨텍스트란 코드를 해석하고 실행하는 환경의 추상적인 개념을 의미한다.

자바스크립트 주요 기능인 스코프, 식별자 및 바인딩, 클로저, 태스크 큐, 이벤트 핸들러와 비동기 처리 등의 동작 원리와 연결된 중요한 개념이다.

### 소스 코드의 실행
개발자가 작성한 모든 소스 코드는 바로 실행되지 않고 평가 과정을 거치며 실행을 위한 준비를 한다.
평가 과정에서 실행 컨텍스트를 생성하고 변수와 함수 선언문만 우선적으로 실행한다.
생성된 변수와 함수 식별자를 실행 컨텍스트가 관리하는 스코프(렉시컬 환경 - 환경 레코드)에 등록한다.

평가 과정이 끝나면 선언문을 제외한 소스 코드가 순차적으로 실행된다.
소스 코드 실행 중 변수나 함수가 참조되면 실행 컨텍스트가 관리하는 스코프에서 검색하여 취득한다.
참조된 변수 값이 변경되면 할당 결과를 실행 컨텍스트가 관리하는 스코프에 등록된다.

코드의 평가 및 실행 순서는 코드 실행부가 함수를 호출하는 코드를 만났을 때 변경될 수 있다.
전역에서 코드가 실행되던 중, 함수를 만나면 실행 중인 코드를 일시중지하고 함수 내부로 진입한다.
실행부가 함수 내부로 진입한 이후에는 함수 코드에 대한 평가 과정이 전역과 동일하게 이루어진다.
따라서, 함수의 실행을 위한 함수 실행 컨텍스트를 새로 생성하게 된다.
또, 지역 변수처럼 사용할 수 있는 `arguments` 객체가 생성되어 지역 스코프에 등록되며 this 바인딩이 결정된다.

### 실행 컨텍스트의 역할
실행 컨텍스트는 소스 코드 실행을 위한 스코프, 식별자, 코드 실행 순서 등을 전체적으로 관리한다.

1. 선언에 의해 생성된 모든 식별자에 대해 스코프를 구분하여 등록하고 지속적으로 관리한다.
    소스 코드 내 변수 식별자가 같더라도 스코프에 따라 다른 값을 호출할 수 있다.
2. 스코프 중첩 관계에 의해 스코프 체인을 형성한다.
    하위 스코프에서 스코프 체인을 통해 상위 스코프로 이동하여 식별자를 검색할 수 있다.
3. 실행 중이던 코드와 새로 실행될 코드를 구분하여 관리한다.
    함수 호출에 의해 실행 순서가 변경되더라도 기존에 실행되었던 코드로 되돌아갈 수 있다.

식별자와 스코프는 실행 컨텍스트의 **렉시컬 환경**으로 관리하고, 실행 순서는 **실행 컨텍스트 스택**으로 관리한다.

---

## 📑 렉시컬 환경 (Lexical Environment)

해석하자면 어휘적 환경을 의미하며 변수 식별자와 값, 상위 스코프에 대한 참조를 기록하는 저장소이다.
렉시컬 환경은 실행 컨텍스트와 같이 생성된다.

**렉시컬 환경의 3요소**는 다음과 같다.
1️⃣ 환경 레코드 (Enviroment Record) : 변수와 함수 선언이 저장되는 공간
1. **객체 환경 레코드 (Object Enviroment Record)**
    - 일반 함수 혹은 `var` 키워드로 선언한 변수는 객체 환경 레코드에 저장된다.
    - 레코드에 저장된 이후에는 전역에 바인딩되어 새로운 엔트리를 생성한다.
        
        이 때, 전역 객체(`window`)에서 제공하는 속성과 메서드를 포함하게 된다.
2. **선언적 환경 레코드 (Declarative Enviroment Record)**
    - 선언 환경 레코드는 전역과 분리되어 있다.
    - `let`, `const` 키워드로 선언한 변수는 선언 환경 레코드에 저장된다
        선언된 이후에는 “**TDZ**”에 위치하게 된다.
        
2️⃣ 외부 렉시컬 환경에 대한 참조
- 외부 렉시컬 환경에 대한 참조는 상위 스코프를 가리킨다.
    상위 스코프란, 해당 실행 컨텍스트를 생성한 소스 코드를 포함하는 상위 코드의 렉시컬 환경을 의미한다.
- 상위 스코프가 없는 전역 스코프는 외부 렉시컬 환경에 대한 참조에 `null`이 할당된다.

3️⃣ “this” 바인딩
- 전역 실행 컨텍스트에서는 전역 환경 레코드인 `[[GlobalThisValue]]`에 바인딩 된 객체를 가리킨다.
    - 일반적으로 `[[GlobalThisValue]]` 는 `window`, `global` 등 전역 객체를 의미한다.
- 함수 실행 컨텍스트에서는 함수가 호출되는 방식에 의해 this가 결정된다.
    - 함수가 객체 참조로 호출될 경우, this에는 해당 객체가 바인딩된다.
- this 바인딩은 전역 환경 레코드, 함수 환경 레코드에만 존재한다.

---

## 📁 실행 컨텍스트 스택
**실행 컨텍스트 스택**은 실행 컨텍스트를 스택 자료구조로 관리하는 공간을 의미한다.

실행 컨텍스트 스택은 나중에 생성(push)된 실행 컨텍스트가 먼저 제거(pop)되는 후입 선출 구조이다.
소스 코드가 평가되면 실행 컨텍스트가 생성되어 실행 컨텍스트 스택의 최상위에 쌓인다.
실행 컨텍스트 스택의 최상위 컨텍스트는 항상 실행 중인 코드의 실행 컨텍스트이다.

현재 실행 중인 실행 컨텍스트에 실행할 코드가 남아있지 않으면 실행 컨텍스트 스택에서 제거된다.
이후 실행 컨텍스트 스택에 컨텍스트가 남아있다면 최상위에 위치한 컨텍스트로 코드의 제어권이 이동한다.

```jsx
const x = 1;

function foo () {
  const y = 2;

  function bar () {
    const z = 3;
    console.log(x + y + z);
  }
  bar();
}

foo(); // 6
```

1. 소스 코드가 실행될 때
    - 전역 코드가 평가되고 전역 실행 컨텍스트가 생성된다.
    - 실행 컨텍스트 스택에 전역 실행 컨텍스트가 추가된다.
    - 전역 코드가 실행된다.
2. 전역 코드 실행 중 `foo` 함수를 만났을 때
    - `foo` 함수 평가 후에 `foo` 함수 실행 컨텍스트가 생성된다.
    - 실행 컨텍스트 스택에 `foo` 함수 실행 컨텍스트가 추가된다.
    - `foo` 함수 코드가 실행된다.
3. `foo` 함수 코드 실행 중 `bar` 함수를 만났을 때
    - `bar` 함수 평가 후에 `bar` 함수 실행 컨텍스트가 생성된다.
    - 실행 컨텍스트 스택에 `bar` 함수 실행 컨텍스트가 추가된다.
    - `bar` 함수 코드가 실행된다.
4. `bar` 함수가 종료될 때
    - 실행 컨텍스트 스택에서 `bar` 함수 실행 컨텍스트가 제거된다.
    - 이후 `foo` 함수 코드로 복귀한다.
5. `foo` 함수가 종료될 때
    - 실행 컨텍스트 스택에서 `foo` 함수 실행 컨텍스트가 제거된다.
    - 이후 전역 코드로 복귀한다.
6. 소스 코드 실행이 완료되었을 때
    - 실행 컨텍스트 스택에서 `bar` 함수 실행 컨텍스트가 제거된다.

---

## 🔄 실행 컨텍스트의 생성과 식별자 검색 과정

1️⃣ 전역 객체 생성

- 전역 객체는 전역 코드가 평가되기 이전에 생성된다.
- 전역 객체에는 빌트인 전역 함수, 표준 빌트인 객체가 추가된다.
- 또한 동작 환경에 따라 클라이언트 사이드 Web API, 특정 환경을 위한 호스트 객체를 포함한다.

2️⃣ 전역 코드 평가

- 소스 코드가 로드된 후 전역 코드를 평가한다.
    1. 전역 실행 컨텍스트 생성
    2. 전역 렉시컬 환경 생성
        1. 전역 환경 레코드 생성
            1. 객체 환경 레코드 생성
            2. 선언적 환경 레코드 생성
        2. 외부 렉시컬 환경에 대한 참조 결정
        3. this 바인딩 결정

3️⃣ 전역 코드 실행

- 코드를 실행하며 변수 할당문, 함수 호출문을 실행하기 위해 식별자를 확인한다.
- 식별자를 참조할 때 어느 스코프의 식별자를 참조해야 하는지 찾는 **식별자 결정**이 수행된다.
- 실행 도중 함수 코드를 만나면 함수 코드로 실행부가 이동한다.

4️⃣ 함수 코드 평가

- 코드 실행 제어권이 전역에서 함수로 이동한다.
- 전역 코드 평가 단계와 동일한 방식으로 함수 코드 평가가 이루어진다.
- 스코프를 결정할 때는 함수를 어디서 호출했는지가 아닌 어디에 정의했는가에 의해 결정된다.

5️⃣ 함수 코드 실행

- 전역 코드 실행 단계와 동일한 방식으로 함수 코드가 실행된다.
- 함수 실행 컨텍스트 내에 존재하지 않는 식별자를 만나면 스코프 체인이 일어나 상위 스코프에서 식별자를 검색한다.

6️⃣ 함수/전역 코드 종료

- 코드가 실행되었던 실행 컨텍스트를 실행 컨텍스트 스택에서 제거한다.
- 코드가 종료되더라도 메모리에서 바로 제거되지 않고 데이터가 참조되지 않게 되었을 때 가비지 컬렉터에 의해 메모리 공간의 확보가 해제되어 소멸한다.

---

## 📎 실행 컨텍스트와 블록 레벨 스코프

`var` 키워드로 선언한 변수는 오직 코드 블록만 지역 스코프로 인정하는 함수 레벨 스코프를 따른다.
반면 `let`, `const` 키워드로 선언한 변수는 모든 코드 블록을 지역 스코프로 인정한다.

if 문의 코드 블록이 실행되면 if 문의 코드 블록 레벨 스코프를 생성해야 한다.
선언적 환경 레코드를 갖는 렉시컬 환경을 새롭게 생성하여 기존 전역 렉시컬 환경을 교체한다.
새롭게 생성된 if 문의 코드 블록을 위한 렉시컬 환경의 외부 렉시컬 환경 참조는 if 문이 실행되기 이전의 렉시컬 환경을 일컫는다

이러한 동작은 if 문 뿐만 아니라 블록 레벨 스코프를 생성하는 모든 블록문에 적용된다.
만약 for 문의 코드 블록 내에서 정의된 함수가 있다면 이 함수의 상위 스코프는 for 문의 코드 블록이 생성한 렉시컬 환경이다.
이때, 함수는 스코프에 코드 블록을 반복 실행할 때마다 식별자 값을 유지해야 한다.

<br />

## 🤔궁금한 점

## 📌중요한 점